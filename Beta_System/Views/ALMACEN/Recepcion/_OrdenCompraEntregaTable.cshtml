@model IEnumerable<Beta_System.Models.C_compras_ordenes_d>
@{
    var contador = 0;
    var modo = ViewBag.OrdenModo;
    var modelo = Model.FirstOrDefault();
    int id_almacen = ViewBag.id_almacen;
}

@if (Model != null && Model.Count() > 0)
{   //PRECARGA
    var precarga = modelo.C_compras_ordenes_precarga_d.Where(x => x.activo == true && x.C_compras_ordenes_precarga_g.activo == true).FirstOrDefault();

    <div class="text-center">
        @try
        {
            <h2 style="margin:0px;" class="bg-beta p-2">Recepcionar en Almacén: @Model.FirstOrDefault().C_compras_ordenes_g.C_compras_ordenes_ubicaciones_entrega.C_almacen_almacenes_ubicaciones_entrega.FirstOrDefault().C_almacen_almacenes_g.nombre_almacen</h2>
            <input value="@Model.FirstOrDefault().C_compras_ordenes_g.C_compras_ordenes_ubicaciones_entrega.C_almacen_almacenes_ubicaciones_entrega.FirstOrDefault().id_almacen_g" id="id_almacen_recepcion_detalle" style="display:none;" />
        }
        catch (Exception)
        {
            <h2 style="margin:0px;" class="text-danger">Ocurrió un error al buscar el almacén asociado a la ubicación de entrega</h2>
            <input value="0" id="id_almacen_recepcion_detalle" style="display:none;" />
        }
    </div>

    if (modo == 2)
    {
        <div class="col-md-4 text-left bg-dark" style="min-height: 6rem;">
            @try
            {
                <h3 style="margin:10px;" class="text-white">Precargado por: @precarga.C_compras_ordenes_precarga_g.C_usuarios_corporativo.C_empleados.nombres @precarga.C_compras_ordenes_precarga_g.C_usuarios_corporativo.C_empleados.apellido_paterno</h3>
                <h3 style="margin:10px;" class="text-white">@string.Format(precarga.C_compras_ordenes_precarga_g.fecha_registro.Value.ToShortDateString(), "dd/mm/yyyy")</h3>
            }
            catch (Exception)
            {

            }
        </div>
        <div class="col-md-6 text-left bg-dark" style="min-height: 6rem;">
            <div class="row">
                <div class="col-md-3" style="padding-top:10px;">
                    <div class="row">
                        <div class="col-md-2"><input class="form-control" style="height: 26px; width: 25px;" type="radio" id="option1" name="radioGroup" value="1" onchange="AccionFactura(1);" checked></div>
                        <div class="col-md-10"><h3 class="text-white">Factura</h3></div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-2"><input class="form-control" style="height: 26px; width: 25px;" type="radio" id="option2" name="radioGroup" value="2" onchange="AccionFactura(2);"></div>
                        <div class="col-md-10"><h3 class="text-white">Remision</h3></div>
                    </div>

                </div>
                <div class="col-md-8 text-left bg-dark" style="min-height: 6rem;">
                    <br />
                    <input type="text" class="form-control" id="factura_folio" placeholder="Ingresa el folio o remisión de la entrega" />
                </div>
            </div>
        </div>
        <div class="col-md-2 text-center bg-dark" style="min-height: 6rem;">
            <br />
            <button class="btn btn_beta" onclick="RegistrarCapturaMovimientoInventarioRecepcion(@modo,@modelo.id_compras_orden_g);">Confirmar</button>
        </div>


        <div class="col-md-12 bg-beta">
            <h2 style="margin:0px;" class="p-2 text-center text-white">Orden de compra: @modelo.id_compras_orden_g </h2>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tabla_recepcion" style="width:100%">
                <thead>
                    <tr class="bg-beta text-center">
                        <th></th>
                        <th>Recepcionar</th>
                        <th>Clave</th>
                        <th>Unidad de medida</th>
                        <th>Ubicación</th>
                        <th>Solicitado</th>
                        <th>Entregado</th>
                        <th>Pendiente</th>
                        <th>Precargado</th>
                        <th>Recibe</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var pendiente = item.cantidad_compra - item.cantidad_entregada;
                        var cant_precarga = item.C_compras_ordenes_precarga_d.Where(x => x.activo == true).FirstOrDefault().cantidad_precarga;
                        var id_articulo = @item.id_articulo + "_" + @contador;
                        <tr class="text-center">
                            @if (item.C_articulos_catalogo.almacenable == true)
                            {
                                <td><input id="check_@item.id_compras_orden_d" type="checkbox" class="form-control check_entrega_articulo" style="min-height: 25px; width: 100%;" onclick="ActivarEntrega(@item.id_compras_orden_d, @modo);" /></td>
                            }
                            else
                            {
                                <td style="color: red">
                                    <i class="fa fa-times" title="Este articulo no es almacenable, contacta a compras"></i>
                                    <br />
                                    <strong style="font-size:10px;">(Artículo no almacenable)</strong>
                                </td>
                            }
                            <td id="@item.id_compras_orden_d" class="orden_articuloD">@item.C_articulos_catalogo.clave</td>
                            <td>@item.C_unidades_medidas.unidad_medida</td>

                            <td>
                                @try
                                {
                                    if (item.C_articulos_catalogo.C_inventario_almacenes_articulos.Count() > 0)
                                    {
                                        var valid_establo = item.C_articulos_catalogo.C_inventario_almacenes_articulos.Where(x => x.id_almacen == id_almacen && x.activo == true);
                                        if (valid_establo != null)
                                        {
                                            <strong class="text-success">@valid_establo.FirstOrDefault().C_almacen_ubicaciones_articulos.nombre_ubicacion</strong>
                                        }
                                        else
                                        {
                                            <strong class="text-danger">NO ASIGNADA</strong>
                                        }
                                    }
                                    else
                                    {
                                        <strong class="text-danger">NO ASIGNADA</strong>
                                    }
                                }
                                catch (Exception)
                                {
                                    <strong class="text-danger">NO ASIGNADA</strong>
                                }
                            </td>

                            <td id="@id_articulo" class="orden_articulo">@item.C_articulos_catalogo.nombre_articulo</td>
                            <td id="cant_solicita_@item.id_compras_orden_d">@string.Format("{0:0.00}", @item.cantidad_compra)</td>
                            <td id="cant_entrega_@item.id_compras_orden_d">@string.Format("{0:0.00}", @item.cantidad_entregada)</td>
                            <td id="cant_pendiente_@item.id_compras_orden_d">@string.Format("{0:0.00}", pendiente)</td>
                            <td id="cant_precarga_@item.id_compras_orden_d">@string.Format("{0:0.00}", @item.C_compras_ordenes_precarga_d.Where(x => x.id_compras_orden_d == item.id_compras_orden_d && x.C_compras_ordenes_precarga_g.recibido == false && x.activo == true).OrderByDescending(x => x.id_precarga_d).FirstOrDefault().cantidad_precarga)</td>
                            <td>
                                <input onkeypress="return isNumberOrDecimalKey(event)" type="text" id="cant_recibido_@item.id_compras_orden_d" class="orden_recibido solo-numeros form-control" onkeyup="ValidarEntregaArticuloEntrega(@item.id_compras_orden_d)" disabled />
                            </td>
                        </tr>
                        contador++;
                    }
                </tbody>
            </table>
        </div>
    }


    //DIRECTO
    else
    {
        <div class="col-md-6 text-center bg-dark pt-2" style="min-height: 6rem;">
            <h3 class="text-left text-white p-2" style="margin:0px;">Orden de compra: #@modelo.id_compras_orden_g </h3>
            <h3 class="text-left text-white p-2" style="margin:0px;">Requisición: @modelo.C_compras_ordenes_g.C_centros_g.siglas - #@modelo.C_compras_ordenes_g.id_requisicion_articulo_g </h3>
        </div>
        <div class="col-md-6 text-left bg-dark" style="min-height: 6rem;">
            <div class="row">
                <div class="col-md-3" style="padding-top:10px;">
                    <div class="row">
                        <div class="col-md-2"><input class="form-control" style="height: 26px; width: 25px;" type="radio" id="option1" name="radioGroup" value="1" onchange="AccionFactura(1);" checked></div>
                        <div class="col-md-10"><h3 class="text-white">Factura</h3></div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-2"><input class="form-control" style="height: 26px; width: 25px;" type="radio" id="option2" name="radioGroup" value="2" onchange="AccionFactura(2);"></div>
                        <div class="col-md-10"><h3 class="text-white">Remision</h3></div>
                    </div>

                </div>
                <div class="col-md-5">
                    <br />
                    <input type="text" class="form-control" id="factura_folio" placeholder="Ingresa el folio o remisión de la entrega" />
                </div>
                <div class="col-md-3 text-right">
                    <br />
                    <button class="btn btn_beta" onclick="RegistrarCapturaMovimientoInventarioRecepcion(@modo,@modelo.id_compras_orden_g);">Confirmar</button>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tabla_recepcion" style="width:100%">
                <thead>
                    <tr class="bg-beta text-center" style="font-size:14px;">
                        <th>Recepcionar</th>
                        <th>Clave</th>
                        <th>Artículo</th>
                        <th>Unidad de medida</th>
                        <th>Ubicación</th>
                        <th>Solicita</th>
                        <th>Entrega</th>
                        <th>Pendiente</th>
                        <th>Recibe</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var pendiente = @item.cantidad_compra - @item.cantidad_entregada;
                        var id_articulo = @item.id_articulo + "_" + @contador;
                        <tr class="text-center">
                            @if (item.C_articulos_catalogo.almacenable == true)
                            {
                                <td><input id="check_@item.id_compras_orden_d" type="checkbox" class="form-control check_entrega_articulo" style="min-height: 25px; width: 100%;" onclick="ActivarEntrega(@item.id_compras_orden_d);" /></td>
                            }
                            else
                            {
                                <td style="color: red">
                                    <i class="fa fa-times" title="Este articulo no es almacenable, contacta a compras"></i>
                                    <br />
                                    <strong style="font-size:10px;">(Artículo no almacenable)</strong>
                                </td>
                            }
                            <td id="@item.id_compras_orden_d" class="orden_articuloD">@item.C_articulos_catalogo.clave</td>
                            <td id="@id_articulo" class="orden_articulo">@item.C_articulos_catalogo.nombre_articulo</td>
                            <td>@item.C_unidades_medidas.unidad_medida</td>

                            <td>
                                @try
                                {
                                    if (item.C_articulos_catalogo.C_inventario_almacenes_articulos.Count() > 0)
                                    {
                                        var valid_establo = item.C_articulos_catalogo.C_inventario_almacenes_articulos.Where(x => x.id_almacen == id_almacen && x.activo == true);
                                        if (valid_establo != null)
                                        {
                                            <strong class="text-success">@valid_establo.FirstOrDefault().C_almacen_ubicaciones_articulos.nombre_ubicacion</strong>
                                        }
                                        else
                                        {
                                            <strong class="text-danger">NO ASIGNADA</strong>
                                        }
                                    }
                                    else
                                    {
                                        <strong class="text-danger">NO ASIGNADA</strong>
                                    }
                                }
                                catch (Exception)
                                {
                                    <strong class="text-danger">NO ASIGNADA</strong>
                                }
                            </td>

                            <td id="cant_solicita_@item.id_compras_orden_d">@string.Format("{0:0.00}", @item.cantidad_compra)</td>
                            <td id="cant_entrega_@item.id_compras_orden_d">@string.Format("{0:0.00}", @item.cantidad_entregada)</td>
                            <td id="cant_pendiente_@item.id_compras_orden_d">@string.Format("{0:0.00}", pendiente)</td>
                            <td>
                                @if (item.C_unidades_medidas.acepta_decimal == 1)
                                {<input onkeypress="return isNumberOrDecimalKey(event, 1)" type="text" id="cant_recibido_@item.id_compras_orden_d" class="orden_recibido solo-numeros form-control" onkeyup="ValidarEntregaArticuloEntrega(@item.id_compras_orden_d, @modo)" onblur="ValidarEntregaArticuloEntrega(@item.id_compras_orden_d, @modo)" disabled />}
                                else
                                { <input onkeypress="return isNumberOrDecimalKey(event,0)" type="text" id="cant_recibido_@item.id_compras_orden_d" class="orden_recibido solo-numeros form-control" onkeyup="ValidarEntregaArticuloEntrega(@item.id_compras_orden_d, @modo)" onblur="ValidarEntregaArticuloEntrega(@item.id_compras_orden_d, @modo)" disabled />}
                            </td>
                        </tr>
                        contador++;
                    }
                </tbody>
            </table>
        </div>
    }


    <hr />
    if (modelo.C_compras_ordenes_g.C_inventario_almacen_mov_g.Count() > 0)
    {
        <h3 style="margin:0px;" class="bg-beta text-center p-2">Recepciones anteriores</h3>
        <div style="height: 250px; overflow: auto; overflow-x: hidden;">
            @foreach (var recepcion in modelo.C_compras_ordenes_g.C_inventario_almacen_mov_g)
            {
                <div class="" id="heading_recepcion_@recepcion.id_inventario_almacen_mov_g">
                    <div class="w-100 collapsed">
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <br />
                                <label>@recepcion.descripcion_mov</label>
                                <br />
                                <strong>Almacén @recepcion.C_almacen_almacenes_g.nombre_almacen</strong>
                            </div>
                            <div class="col-md-2 text-center pt-3">
                                <label>Fecha recepción:</label>
                                <br />
                                <strong>@string.Format(recepcion.fecha_registro.ToString(), "dd/mm/yyyy HH:MM")</strong>
                            </div>
                            <div class="col-md-2 text-center pt-3">
                                <label>Factura/Remisión</label>
                                <br />
                                <strong>@recepcion.folio_remi_fact</strong>
                            </div>
                            <div class="col-md-1 text-center p-3">
                                <button class="btn btn_beta" style="background-color:@recepcion.C_inventario_mov_status.color;color: white;">@recepcion.C_inventario_mov_status.nombre_status</button>
                            </div>
                            <div class="col-md-2 text-center pt-4">
                                <h4 class="mt-2">VER RECEPCIÓN</h4>
                            </div>
                            <div class="col-md-2 text-center pt-3">
                                <button class="btn btn_beta_icon" data-toggle="collapse" data-target="#collapse_@recepcion.id_inventario_almacen_mov_g" aria-expanded="false" aria-controls="collapse_@recepcion.id_inventario_almacen_mov_g"><i class="fa fa-bars"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="collapse_@recepcion.id_inventario_almacen_mov_g" class="collapse btn_detalle_requi_aut" aria-labelledby="heading_recepcion_@recepcion.id_inventario_almacen_mov_g" @*data-parent="#accordionSolicitudes"*@>
                    <div class="table-responsive text-dark text-white">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr class="bg-beta">
                                    <th>Fact./Rem.</th>
                                    <th>Usuario recepciona</th>
                                    <th>Clave</th>
                                    <th>Articulo</th>
                                    <th>Cantidad</th>
                                    <th>Unidad medida</th>
                                    <th>Estatus</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var det in recepcion.C_inventario_almacen_mov_d_recepciones_logs.OrderBy(x => x.fecha_recepcion))
                                {
                                    <tr>
                                        <td>@det.folio_remision_factura</td>
                                        @*<td>@det.fecha_recepcion.Value.ToShortDateString()</td>*@
                                        <td>@det.C_usuarios_corporativo.usuario</td>
                                        <td>@det.C_articulos_catalogo.clave</td>
                                        <td>@det.C_articulos_catalogo.nombre_articulo</td>
                                        <td>@det.cantidad_recepcion.Value.ToString("N2")</td>
                                        <td>@det.C_articulos_catalogo.C_unidades_medidas.unidad_medida</td>
                                        <td>
                                            <button class="btn btn-xs" style="color: white; background-color: @det.C_inventario_almacen_mov_d.C_inventario_mov_status.color">@det.C_inventario_almacen_mov_d.C_inventario_mov_status.nombre_status</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    }
}
else
{
    <h2 class="text-center" style="color:red">NO SE ENCONTRO LA ORDEN DE COMPRA O YA SE RECIBIO</h2>
    <br />
    <label>@ViewBag.ex_msj</label>
}

<script>
    $(window).on("load", function () {
        CaracteresControl();
    });

    function isNumberOrDecimalKey(evt, unidad) {
        var charCode = (evt.which) ? evt.which : event.keyCode;
        //UNIDAD 1 DECIMAL
        //UNIDAD 0 ENTERO
        if (unidad == 1) {
            // Allow only numbers and a single decimal point
            if (charCode > 31 && (charCode < 48 || charCode > 57) && charCode !== 46) {
                return false;
            }

            // Allow only one decimal point
            var input = evt.target.value;
            if (input.indexOf('.') !== -1 && charCode === 46) {
                return false;
            }

            return true;
        }
        else {
            // Allow only numbers and a single decimal point
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }

            return true;
        }
    }
</script>
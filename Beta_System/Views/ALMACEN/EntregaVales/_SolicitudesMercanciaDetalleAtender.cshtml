@model IEnumerable<Beta_System.Models.C_almacen_solicitudes_mercancia_d>
@{ 
    var entregado = Model.OrderByDescending(x => x.cantidad_entregada).FirstOrDefault();
}

@if (Model.Count() > 0)
{
    var solicitud = Model.FirstOrDefault().C_almacen_solicitudes_mercancia_g;
    int id_almacen = (int)solicitud.id_almacen_g;
    <div class="modal-header" style="display:block">
       <div class="row">
           <div class="col-md-2" style="padding-top:10px">
               <strong style="font-size:24px;">Detalle de la solicitud</strong>
           </div>
           <div class="col-md-2 text-center">
               <button type="button" class="btn btn_beta_warning text-white" onclick="CerrarVale(@solicitud.id_solicitud_mercancia_g);" id="btn_cerrar_vale"><i class="fa fa-check-square-o"></i>    CERRAR VALE</button>
           </div>
           <div class="col-md-2 text-center">
               @if (entregado.cantidad_entregada == 0)
               {
                   <button type="button" class="btn btn_beta_danger" onclick="CancelarVale(@solicitud.id_solicitud_mercancia_g,1);" id="btn_cerrar_vale"><i class="fa fa-remove"></i>    CANCELAR VALE</button>
               }
               else
               {
                   <button type="button" class="btn btn_beta_danger" onclick="CancelarVale(@solicitud.id_solicitud_mercancia_g,0);" id="btn_cerrar_vale"><i class="fa fa-remove"></i>    CANCELAR VALE</button>
               }
           </div>
           <div class="col-md-2 text-center">
               <button type="button" class="btn btn_beta" onclick="CambiarCuentaVale(@solicitud.id_solicitud_mercancia_g);" id="btn_cambiar_cuenta_vale"><i class="fa fa-refresh"></i>    CAMBIAR CUENTA</button>
           </div>
           <div class="col-md-4 text-right">
               <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                   <span aria-hidden="true">&times;</span>
               </button>
           </div>
       </div>
    </div>
    <div class="modal-body" style="overflow: scroll; min-height: 500px; height: 500px; overflow-x: hidden;">
        <div class="">
            <div class="row">
                <div class="col-md-2 text-left">
                    <h3 style="margin:0px;"><strong>Folio: #@solicitud.id_solicitud_mercancia_g</strong></h3>
                </div>
                <div class="col-md-4 text-center">
                    <h3 style="margin:0px;">Cargo: @solicitud.cargo_desc</h3>
                </div>
                <div class="col-md-6 text-right">
                    <strong>Fecha de registro: @String.Format(solicitud.fecha_registro.ToString(), "dd/MM/yyyy")</strong><br />
                    <button class="btn" style="color:white; background-color:@solicitud.C_almacen_solicitudes_status.color">@solicitud.C_almacen_solicitudes_status.nombre_status</button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-5 text-left">
                    <label>Centro: <strong>@solicitud.C_centros_g.nombre_centro</strong></label><br />
                    <label>Departamento: <strong>@solicitud.C_departamentos_g.nombre_departamento</strong></label><br />
                    <label>Almacén: <strong>@solicitud.C_almacen_almacenes_g.nombre_almacen</strong></label><br />
                    <label>Equipo:  <strong>@solicitud.C_establos_equipos.clave_equipo</strong> @solicitud.C_establos_equipos.nombre_equipo</label>
                </div>
                <div class="col-md-5 text-left">
                    <label>Registrado por: <strong>@solicitud.C_empleados.nombres @solicitud.C_empleados.apellido_paterno</strong></label><br />
                    @try
                    {
                        if (solicitud.id_empleado_remitente != null)
                        {
                            <label>Solicita: <strong>@solicitud.C_nomina_empleados.Nombres @solicitud.C_nomina_empleados.Apellido_paterno</strong></label><br />
                        }
                        else
                        {
                            <label>Solicita: <strong>@solicitud.C_empleados.nombres @solicitud.C_empleados.apellido_paterno</strong></label><br />
                        }
                    }
                    catch (Exception) { }

                    @if (@solicitud.C_usuarios_corporativo1 != null)
                    {
                        <label>Autorizado por: <strong>@solicitud.C_usuarios_corporativo1.C_empleados.nombres @solicitud.C_usuarios_corporativo1.C_empleados.apellido_paterno</strong></label><br />
                    }

                    @if (@solicitud.C_usuarios_corporativo2 != null)
                    {
                        <label>Surtió: <strong>@solicitud.C_usuarios_corporativo2.C_empleados.nombres @solicitud.C_usuarios_corporativo2.C_empleados.apellido_paterno</strong></label>
                    }
                </div>
                <div class="col-md-2 text-right">
                    <strong>Imprimir</strong>
                    <button class="btn btn_beta_icon" onclick="GenerarValePDF(@solicitud.id_solicitud_mercancia_g, 'div_entrega_mercancia_vale');"><i class="fa fa-print"></i></button>
                    <h3 style="margin: 2px;"><strong>Total: $@solicitud.total</strong></h3>
                </div>
            </div>
            <hr />
            <h3 class="text-center">ARTÍCULOS</h3>
            <div class="table-responsive">
                <table class="table table-striped table-bordered" id="tabla_solicitudes_detalle" style="width:100%;">
                    <thead>
                        <tr class="text-center bg-beta">
                            <th>Surtir</th>
                            <th>Cant. entregar</th>
                            <th>Entregado</th>
                            <th>Requerido</th>
                            <th>Existencia</th>
                            <th>Artículo</th>
                            <th>Descripción</th>
                            <th>Unidad</th>
                            <th>Precio</th>
                            <th>Importe</th>
                            <th>Cargo Contable</th>
                            <th>Observaciones</th>
                            <th>Ubicación</th>
                            <th>Cambiar</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr class="text-center" style="font-size: 18px;">
                                <td>
                                    @*SURTIR*@
                                    <input type="checkbox" class="form-control check_entrega_articulo" style="min-height: 25px; width: 100%;"
                                           id="check_@item.id_solicitud_mercancia_d" name="@item.id_solicitud_mercancia_d" onclick="RellenarEntregaArticulo(@item.id_solicitud_mercancia_d);" />
                                </td>

                                <td>
                                    @*ENTREGAR*@
                                    @if (item.C_unidades_medidas.acepta_decimal == 1)
                                    {
                                        @*<div class="divEditable" id="cant_entrega_@item.id_solicitud_mercancia_d" onkeyup="ValidarEntregaArticulo(@item.id_solicitud_mercancia_d);" oninput="TablaDecimal(this);" contenteditable="true">0</div>*@

                                        <input class="form-control" id="cant_entrega_@item.id_solicitud_mercancia_d" onkeyup="ValidarEntregaArticulo(@item.id_solicitud_mercancia_d);" oninput="TablaDecimal(this);" disabled />
                                    }
                                    else
                                    {
                                        @*<div class="divEditable" id="cant_entrega_@item.id_solicitud_mercancia_d" onkeyup="ValidarEntregaArticulo(@item.id_solicitud_mercancia_d);" oninput="TablaEntero(this);" contenteditable="true">0</div>*@

                                        <input class="form-control" id="cant_entrega_@item.id_solicitud_mercancia_d" onkeyup="ValidarEntregaArticulo(@item.id_solicitud_mercancia_d);" oninput="TablaEntero(this);" disabled />
                                    }

                                </td>

                                <td>
                                    @*ENTREGADO*@
                                    <div id="cant_entregado_@item.id_solicitud_mercancia_d">@item.cantidad_entregada</div>
                                </td>


                                <td>
                                    @*SOLICITADA*@
                                    <div id="cant_solicitada_@item.id_solicitud_mercancia_d">@item.cantidad</div>
                                </td>

                                <td id="div_existencia_@item.id_solicitud_mercancia_d">
                                    @*EXISTENCIA*@
                                    <div id="cant_existencia_@item.id_solicitud_mercancia_d">
                                        @item.C_articulos_catalogo.descripcion_articulo
                                    </div>
                                </td>

                                <td><strong>@item.C_articulos_catalogo.clave</strong></td>
                                <td><strong>@item.C_articulos_catalogo.nombre_articulo</strong></td>
                                <td>@item.C_unidades_medidas.unidad_medida</td>

                                <td>@string.Format("{0:C}", @item.costo)</td>
                                <td>@string.Format("{0:C}", @item.importe)</td>

                                <td>@item.cargo_cuenta_contable</td>
                                <td>@item.observaciones</td>

                                <td>
                                    @try
                                    {
                                        if (item.C_articulos_catalogo.C_inventario_almacenes_articulos.Count() > 0)
                                        {
                                            var valid_establo = item.C_articulos_catalogo.C_inventario_almacenes_articulos.Where(x => x.id_almacen == id_almacen && x.activo == true);
                                            if (valid_establo != null)
                                            {
                                                <strong class="text-success">@valid_establo.FirstOrDefault().C_almacen_ubicaciones_articulos.nombre_ubicacion</strong>
                                            }
                                            else
                                            {
                                                <strong class="text-danger">NO ASIGNADA</strong>
                                            }
                                        }
                                        else
                                        {
                                            <strong class="text-danger">NO ASIGNADA</strong>
                                        }
                                    }
                                    catch (Exception)
                                    {
                                        <strong class="text-danger">NO ASIGNADA</strong>
                                    }
                                </td>

                                <td>
                                    @if (solicitud.id_status_solicitud == 3) { }
                                    else if (item.cantidad_entregada > 0)
                                    {
                                        <strong class="text-danger">@Convert.ToInt32(item.cantidad_entregada) ENTREGADOS</strong>
                                    }
                                    else
                                    {<button class="btn btn_beta_icon" onclick="CambiarArticuloEntrega(@item.id_solicitud_mercancia_d, '@item.C_articulos_catalogo.nombre_articulo', @item.C_articulos_catalogo.id_articulo, @item.id_solicitud_mercancia_g);"><i class="fa fa-refresh"></i></button>}
                                </td>

                            </tr>
                            @*<script>ConsultarExistenciaArticuloAlmacen(@item.id_solicitud_mercancia_d, @solicitud.id_almacen_g, @item.id_articulo)</script>*@

                        }
                    </tbody>
                </table>
            </div>
            <br />
            <hr />
            <div class="table-responsive">
                <div id="div_cambios_solicitud"></div>
            </div>

            <div class="col-md-12">
                <hr />
            </div>
        </div>
        <div class="container">
            <div id="div_entrega_mercancia_vale"></div>
        </div>
    </div>

    <div class="modal-footer">
        <div class="row">
            <div class="col-md-8 text-left">
                <button type="button" class="btn btn_beta" onclick="EntregarVale(@solicitud.id_solicitud_mercancia_g);" id="btn_entregar_vale">ENTREGAR VALE <i class="fa fa-check"></i></button>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn_beta_danger" data-dismiss="modal">CERRAR</button>
            </div>
        </div>
    </div>
}


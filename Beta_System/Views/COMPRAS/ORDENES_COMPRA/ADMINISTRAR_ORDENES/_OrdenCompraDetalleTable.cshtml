@model IEnumerable<Beta_System.Models.C_compras_ordenes_d>

<style>
    .hh-grayBox {
        background-color: #F8F8F8;
        margin-bottom: 20px;
        padding: 35px;
        margin-top: 20px;
    }

    .pt45 {
        padding-top: 45px;
    }

    .order-tracking {
        text-align: center;
        width: 14%;
        position: relative;
        display: block;
    }

        .order-tracking .is-complete {
            display: block;
            position: relative;
            border-radius: 50%;
            height: 30px;
            width: 30px;
            border: 0px solid #AFAFAF;
            background-color: #f7be16;
            margin: 0 auto;
            transition: background 0.25s linear;
            -webkit-transition: background 0.25s linear;
            z-index: 2;
        }

            .order-tracking .is-complete:after {
                display: block;
                position: absolute;
                content: '';
                height: 14px;
                width: 7px;
                top: -2px;
                bottom: 0;
                left: 5px;
                margin: auto 0;
                border: 0px solid #AFAFAF;
                border-width: 0px 2px 2px 0;
                transform: rotate(45deg);
                opacity: 0;
            }

        .order-tracking.completed .is-complete {
            border-color: #27aa80;
            border-width: 0px;
            background-color: #27aa80;
        }

            .order-tracking.completed .is-complete:after {
                border-color: #fff;
                border-width: 0px 3px 3px 0;
                width: 7px;
                left: 11px;
                opacity: 1;
            }

        .order-tracking p {
            color: #A4A4A4;
            font-size: 16px;
            margin-top: 8px;
            margin-bottom: 0;
            line-height: 20px;
        }

            .order-tracking p span {
                font-size: 14px;
            }

        .order-tracking.completed p {
            color: #000;
        }

        .order-tracking::before {
            content: '';
            display: block;
            height: 3px;
            width: calc(100% - 40px);
            background-color: #f7be16;
            top: 13px;
            position: absolute;
            left: calc(-50% + 20px);
            z-index: 0;
        }

        .order-tracking:first-child:before {
            display: none;
        }

        .order-tracking.completed:before {
            background-color: #27aa80;
        }
</style>

@{
    var requi = Model.FirstOrDefault().C_compras_ordenes_g.C_compras_requi_g;
    var firma = ViewBag.firmas;
    var monto = ViewBag.monto_usuario;
    var orden_compra = Model.FirstOrDefault().C_compras_ordenes_g;
    decimal valor_dolar = Convert.ToDecimal(ViewBag.valor_dolar);
    Html.RenderAction("ConsultarInformacionRequisicionHeader", "REQUISICIONES", new { id_requisicion = requi.id_requisicion_articulo_g });
}

<div class="col-md-12" style="display:none">
    <label id="status_orden">@Model.FirstOrDefault().C_compras_ordenes_g.id_status_orden</label>
</div>

<h2 class="text-center bg-beta">DETALLE DE LA ORDEN</h2>
<div class="row">
    <div class="col-md-7 text-left">
        <label>No. orden: </label><strong> @orden_compra.id_compras_orden_g</strong>
        <br />
        <label>Nombre de orden: </label><strong> @orden_compra.C_compras_cotizaciones_confirmadas_g.nombre_suborden</strong>
        <br />
        <label>Proveedor:</label><strong> @orden_compra.C_compras_proveedores.razon_social</strong>
        @if (orden_compra.id_tipo_orden != 2)
        {
            <br />
            <label>Ubicación de entrega: <strong>@orden_compra.C_compras_ordenes_ubicaciones_entrega.nombre_ubicacion</strong></label>
        }

        <h3 style="margin:3px;" class="text-left text-success"><strong>Subtotal: $@Model.Where(x => x.activo == true).Select(x => x.precio_unitario * x.cantidad_compra).Sum().Value.ToString("N2") (@orden_compra.C_compras_proveedores.C_tipos_moneda.clave_fiscal)</strong></h3>
    </div>
    <div class="col-md-3 text-left">
        <label>Fecha autorización: </label><strong> @string.Format(orden_compra.fecha_registro.Value.ToShortDateString(), "dd/mm/yyyy")</strong>
        <br />
        <label>Usuario autorizó: </label><strong> @orden_compra.C_usuarios_corporativo.C_empleados.nombres @orden_compra.C_usuarios_corporativo.C_empleados.apellido_paterno</strong>
        <br />
        <label>Usuario cotizó: </label><strong> @orden_compra.C_compras_cotizaciones_confirmadas_g.C_usuarios_corporativo.C_empleados.nombres @orden_compra.C_compras_cotizaciones_confirmadas_g.C_usuarios_corporativo.C_empleados.apellido_paterno</strong>
    </div>
    <div class="col-md-2 text-center">
        <strong>RECEPCIONADA</strong>
        <br />
        @if (orden_compra.entregado == true)
        {<i class="fa fa-2x fa-check" style="color: #46E63E; "></i> }
        else
        { <i class="fa fa-2x fa-clock-o" style="color: #eb3c3c;"></i>}


        @if (orden_compra.C_inventario_almacen_mov_g.Where(x => x.id_inventario_mov_status == 2).Count() > 0)
        {
            <br />
            <label style="margin:0px;">Factura/Remisión recibida:</label>
            <br />
            <strong># @orden_compra.C_inventario_almacen_mov_g.FirstOrDefault().folio_remi_fact</strong>
        }
        @try
        {
            <br />
            <label style="margin:0px;">Fecha recepción:</label>
            <br />
            <strong>@string.Format(orden_compra.fecha_recepcion.Value.ToShortDateString(), "dd/MM/yyyy")</strong>
        }
        catch (Exception)
        {

        }
    </div>
</div>
<hr />
<div style="height:400px; min-height:400px; overflow:auto; overflow-x:hidden;">
    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="datatable_orden_compra_detalle">
            <thead class="text-center">
                <tr class="bg-beta">
                    <th>Articulo</th>
                    <th>Descripción</th>
                    <th>Unidad</th>
                    <th>Cantidad</th>
                    <th>Entregado</th>
                    <th>Precio</th>
                    <th>Importe $</th>
                    <th>Moneda</th>
                    <th>Cargo contable</th>
                    <th>Cuenta</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Where(x => x.activo == true))
                {
                    decimal importe = (decimal)item.precio_unitario * (decimal)item.cantidad_compra;
                    <tr class="text-center">
                        <td>@item.C_articulos_catalogo.clave</td>
                        <td>@item.C_articulos_catalogo.nombre_articulo</td>
                        <td>@item.C_unidades_medidas.unidad_medida</td>
                        <td>@string.Format("{0:0.00}", item.cantidad_compra)</td>
                        <td>@string.Format("{0:0.00}", item.cantidad_entregada)</td>
                        <td>$@item.precio_unitario.Value.ToString("N2")</td>
                        <td>$@importe.ToString("N2")</td>
                        <td>
                            <label>@item.C_tipos_moneda.clave_fiscal</label>
                            @if (item.id_tipo_moneda != 1)
                            {<strong>($@valor_dolar.ToString("N2"))</strong>}
                        </td>
                        <td>@item.C_cargos_contables_g.nombre_cargo</td>
                        <td>
                            <strong>@item.C_cuentas_contables_g.cuenta</strong>
                            <br />
                            <label>@item.C_cuentas_contables_g.nombre_cuenta</label>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (orden_compra.C_inventario_almacen_mov_g.Count() > 0)
    {
        <h2 class="text-center bg-beta">RECEPCIONES</h2>
        foreach (var recepcion in orden_compra.C_inventario_almacen_mov_g)
        {
            <div class="" id="heading_recepcion_@recepcion.id_inventario_almacen_mov_g">
                <div class="w-100 collapsed" style="border: 1px solid black; background-color: rgb(236, 244, 251);">
                    <div class="row">
                        <div class="col-md-2 text-center">
                            <br />
                            <strong>Almacén @recepcion.C_almacen_almacenes_g.nombre_almacen</strong>
                            <br />
                            <label>@recepcion.descripcion_mov</label>
                        </div>
                        <div class="col-md-2 text-center pt-3">
                            <label>Factura / remisión:</label>
                            <br />
                            @if (recepcion.C_inventario_almacen_mov_d_recepciones_logs.Count() > 0)
                            {
                                <strong>@recepcion.C_inventario_almacen_mov_d_recepciones_logs.FirstOrDefault().folio_remision_factura</strong>
                            }
                        </div>
                        <div class="col-md-2 text-center">
                            <br />
                            <strong>Usuario recepciona</strong>
                            <br />
                            <label>@recepcion.C_usuarios_corporativo.usuario</label>
                        </div>
                        <div class="col-md-2 text-center pt-3">
                            <label>Fecha recepción:</label>
                            <br />
                            <strong>@string.Format(recepcion.fecha_registro.Value.ToShortDateString(), "dd/mm/yyyy")</strong>
                        </div>
                        <div class="col-md-1 text-center pt-3">
                            <button class="btn btn_beta" style="background-color:@recepcion.C_inventario_mov_status.color;color: white;">@recepcion.C_inventario_mov_status.nombre_status</button>
                        </div>
                        <div class="col-md-2 text-center pt-4">
                            <h4 class="mt-2">VER RECEPCIÓN</h4>
                        </div>
                        <div class="col-md-1 text-center p-3">
                            <button class="btn btn_beta_icon" data-toggle="collapse" data-target="#collapse_@recepcion.id_inventario_almacen_mov_g" aria-expanded="false" aria-controls="collapse_@recepcion.id_inventario_almacen_mov_g"><i class="fa fa-bars"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="collapse_@recepcion.id_inventario_almacen_mov_g" class="collapse btn_detalle_requi_aut" aria-labelledby="heading_recepcion_@recepcion.id_inventario_almacen_mov_g" @*data-parent="#accordionSolicitudes"*@>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr class="bg-beta text-center">
                            @*<th>Folio</th>*@
                            @*<th>Fecha</th>*@
                            @*<th>Usuario recepciona</th>*@
                            <th>Clave</th>
                            <th>Articulo</th>
                            <th>Unidad medida</th>
                            <th>Tipo</th>
                            <th>Clasificación</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var det in recepcion.C_inventario_almacen_mov_d_recepciones_logs)
                        {
                            <tr class="text-center">
                                @*<td>@det.folio_remision_factura</td>*@
                                @*<td>@det.fecha_recepcion.Value.ToShortDateString()</td>*@
                                @*<td>@det.C_usuarios_corporativo.usuario</td>*@
                                <td><strong>@det.C_articulos_catalogo.clave</strong></td>
                                <td class="text-left"><strong>@det.C_articulos_catalogo.nombre_articulo</strong></td>
                                <td><strong>@det.C_articulos_catalogo.C_unidades_medidas.unidad_medida</strong></td>
                                <td>@det.C_articulos_catalogo.C_articulos_tipos.nombre_tipo</td>
                                <td>@det.C_articulos_catalogo.C_articulos_clasificaciones.nombre_clasificacion</td>
                                <td><strong>@det.cantidad_recepcion.Value.ToString("N2")</strong></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }


    <h2 class="text-center bg-beta">TRACKING ORDEN</h2>
    <div class="row">
        <div class="col-12 col-md-12 hh-BackgroundBox">
            <div class="p-2">
                @if (orden_compra.C_compras_facturas_proveedores.Where(x => x.activo == true).Count() > 0)
                {
                    <div class="" id="heading_@orden_compra.id_compras_orden_g">
                        <div class="w-100 collapsed" style="border: 1px solid black; background-color: rgb(236, 244, 251);">
                            <div class="row">
                                <div class="col-md-8"></div>
                                <div class="col-md-3 p-3">
                                    <h4 class="text-left">VER FACTURA</h4>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn_beta_icon" data-toggle="collapse" data-target="#collapse_@orden_compra.id_compras_orden_g" aria-expanded="false" aria-controls="collapse_@orden_compra.id_compras_orden_g"><i class="fa fa-bars"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="collapse_@orden_compra.id_compras_orden_g" class="collapse btn_detalle_requi_aut" aria-labelledby="heading_@orden_compra.id_compras_orden_g" data-parent="#accordionSolicitudes">
                        <div class="table-responsive" style="border: 2px solid black; background-color: rgb(236, 244, 251);">
                            <table class="table table-bordered table-striped text-center">
                                <thead>
                                    <tr class="bg-beta">
                                        <th>Factura</th>
                                        <th>Fecha de registro</th>
                                        <th>Subtotal</th>
                                        <th>IVA</th>
                                        <th>IVA retenido</th>
                                        <th>ISR</th>
                                        <th>Total</th>
                                        <th>Moneda</th>
                                        <th>Importada</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var factura in orden_compra.C_compras_facturas_proveedores)
                                    {
                                        <tr>
                                            <td>@factura.folio_factura</td>
                                            <td>@string.Format(factura.fecha_registro.Value.ToShortDateString(), "dd/MM/yyyyy")</td>
                                            <td>$@factura.subtotal.Value.ToString("N2")</td>
                                            <td>$@factura.iva_monto.Value.ToString("N2")</td>
                                            <td>$@factura.iva_retenido_monto.Value.ToString("N2")</td>
                                            <td>$@factura.isr_monto.Value.ToString("N2")</td>
                                            <td>$@factura.total.Value.ToString("N2")</td>
                                            <td>@factura.moneda</td>
                                            <td>
                                                @if (factura.aplicado == true)
                                                {
                                                    <div class="row">
                                                        <div class="col-md-6 text-center">
                                                            <button class="btn btn_beta" onclick="MostrarOrdenCompraPDFProveedor(@factura.id_compras_orden_g);">Ver PDF</button>
                                                        </div>
                                                        <div class="col-md-4 text-center">
                                                            <button class="btn btn_beta" onclick="MostrarOrdenCompraXMLProveedor(@factura.id_compras_orden_g);">Abrir XML</button>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                { <i class="fa fa-3x fa-clock-o" style="color: #eb3c3c;"></i>}
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }

                <div class="" id="heading_tracking_@orden_compra.id_compras_orden_g">
                    <div class="w-100 collapsed" style="border: 1px solid black; background-color: rgb(236, 244, 251);">
                        <div class="row">
                            <div class="col-md-8"></div>
                            <div class="col-md-3 p-3">
                                <h4 class="text-left">VER TRACKING</h4>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn_beta_icon" data-toggle="collapse" data-target="#collapse_tracking_@orden_compra.id_compras_orden_g" aria-expanded="false" aria-controls="collapse_tracking_@orden_compra.id_compras_orden_g"><i class="fa fa-bars"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="collapse_tracking_@orden_compra.id_compras_orden_g" class="collapse btn_detalle_requi_aut" aria-labelledby="heading_tracking_@orden_compra.id_compras_orden_g" data-parent="#accordionTracking">
                    <div class="p-2" style="border: 2px solid black; background-color: rgb(236, 244, 251);">
                        <div class="row">
                            @foreach (var art in orden_compra.C_compras_ordenes_d.Where(x => x.activo == true))
                            {
                                <div class="col-md-3">
                                    <label><strong>-@art.C_articulos_catalogo.clave</strong> @art.C_articulos_catalogo.nombre_articulo <strong>(@art.cantidad_compra.Value.ToString("N2") @art.C_unidades_medidas.unidad_medida) - $@art.precio_unitario.Value.ToString("N2") @art.C_tipos_moneda.clave_fiscal</strong></label>
                                </div>
                            }
                        </div>
                        <div class="row justify-content-between">
                            @if (orden_compra.entregado == true)
                            {
                                <div class="order-tracking completed col-md-3">
                                    <span class="is-complete"></span>
                                    <p>Recepcionado<br></p>
                                </div>
                            }
                            else
                            {
                                <div class="order-tracking col-md-3">
                                    <span class="is-complete"></span>
                                    <p>Recepcionado<br></p>
                                </div>
                            }


                            @if (orden_compra.alta_proveedor == true)
                            {
                                <div class="order-tracking completed col-md-3">
                                    <span class="is-complete"></span>
                                    <p>Factura en portal<br></p>
                                </div>
                            }
                            else
                            {
                                <div class="order-tracking col-md-3">
                                    <span class="is-complete"></span>
                                    <p>Factura en portal<br></p>
                                </div>
                            }


                            @if (orden_compra.C_compras_facturas_proveedores.Count() > 0)
                            {
                                foreach (var factura in orden_compra.C_compras_facturas_proveedores)
                                {
                                    if (factura.activo == true && factura.aplicado == true)
                                    {
                                        <div class="order-tracking completed col-md-3">
                                            <span class="is-complete"></span>
                                            <p>Importó contabilidad<br></p><span>@string.Format(orden_compra.C_compras_facturas_proveedores.FirstOrDefault().fecha_registro.Value.ToLongDateString(), "dd/MM/yyyy")</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="order-tracking col-md-3">
                                            <span class="is-complete"></span>
                                            <p>Importó contabilidad<br></p><span></span>
                                        </div>
                                    }


                                    if (factura.C_contabilidad_importacion_facturas_d.Count() > 0)
                                    {
                                        <div class="order-tracking completed col-md-3">
                                            <span class="is-complete"></span>
                                            <p>Importada Microsip<br></p>
                                            <span>Factura: @factura.folio_factura</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="order-tracking col-md-3">
                                            <span class="is-complete"></span>
                                            <p>Importada Microsip<br></p><span></span>
                                        </div>
                                    }

                                }
                            }
                            else
                            {
                                <div class="order-tracking col-md-3">
                                    <span class="is-complete"></span>
                                    <p>Importó contabilidad<br><span></span></p>
                                </div>

                                <div class="order-tracking col-md-3">
                                    <span class="is-complete"></span>
                                    <p>Importada Microsip<br><span></span></p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

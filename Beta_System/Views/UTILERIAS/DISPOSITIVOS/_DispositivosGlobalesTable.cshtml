@model IEnumerable<Beta_System.Models.C_dispositivos_autorizados>
@{
    var comandosGlobales = ViewBag.ListaComandosGlobales as List<Beta_System.Models.C_dispositivos_comandos_globales>;
    var comandosEjecutados = ViewBag.ListaComandosEjecutados as List<Beta_System.Models.C_dispositivos_comandos_ejecutados>;

    var conteoPorTipo = Model
        .GroupBy(x => x.id_dispositivo_tipo)
        .ToDictionary(g => g.Key, g => g.Count());

    var totalDispositivos = Model.Count();
}

<style>
    .card-group {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 30px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
</style>

<div class="col-md-12 card-group">
    <h2>DISPOSITIVOS</h2>
    <hr />
    @foreach (var tipo in Model.GroupBy(x => x.id_dispositivo_tipo))
    {
        <div class="col-md-12 card-group">
            <strong>@tipo.FirstOrDefault().C_dispositivos_tipos.tipo_dispositivo.ToUpper() (@tipo.Count())</strong>
            <div class="col-md-12"><hr /></div>
            <div style="overflow-x: auto; max-width: 100%;">
                <table class="table table-striped table-bordered dispositivos_lista_table" style="width:100%; table-layout: fixed;">
                    <thead>
                        <tr class="bg-beta text-center">
                            <th style="width:55%; white-space: nowrap;">Dispositivo</th>
                            <th style="width:22%; white-space: nowrap;">MAC</th>
                            <th style="width:17%; white-space: nowrap;">Establo</th>
                            <th style="width:6%; white-space: nowrap;">Kiosko</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in tipo)
                        {
                            <tr>
                                <td>@item.dispositivo</td>
                                <td>@item.mac_address</td>
                                <td>@item.C_establos.nombre_establo</td>
                                <td>
                                    @if (item.bloqueo == true)
                                    {
                                        <label style="color:green">Activo</label>
                                    }
                                    else
                                    {
                                        <label style="color:red">Inactivo</label>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<div class="col-md-12 card-group">
    <h2>COMANDOS GLOBALES</h2>
    <hr />
    <div style="overflow-x: auto; max-width: 100%;">
        <table class="table table-striped table-bordered" id="dispositivos_lista_comandos_table" style="width:100%; table-layout: fixed;">
            <thead>
                <tr class="bg-beta text-center">
                    <th style="width:6%; white-space: nowrap;">ID Global</th>
                    <th style="width:16%; white-space: nowrap;">Comando</th>
                    <th style="width:30%; white-space: nowrap;">Parametro</th>
                    <th style="width:4%; white-space: nowrap;">Global</th>
                    <th style="width:15%; white-space: nowrap;">Tipo</th>
                    <th style="width:15%; white-space: nowrap;">Dispositivo</th>
                    <th style="width:6%; white-space: nowrap;">Perpetuo</th>
                    <th style="width:8%; white-space: nowrap;">Pendientes</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in comandosGlobales)
                {
                    int ejecutados = comandosEjecutados
                        .Where(x => x.id_comando_global == item.id_comando_global)
                        .Select(x => x.mac_address)
                        .Distinct()
                        .Count();

                    int total = 0;

                    if (item.para_todos == true)
                    {
                        total = totalDispositivos;
                    }
                    else if (item.para_tipo != null)
                    {
                        total = conteoPorTipo.ContainsKey(item.para_tipo) ? conteoPorTipo[item.para_tipo] : 0;
                    }
                    else if (!string.IsNullOrEmpty(item.para_mac))
                    {
                        total = 1;
                    }

                    int faltan = total - ejecutados;

                    <tr>
                        <td class="text-center">@item.id_comando_global</td>
                        <td>@item.C_dispositivos_comandos_catalogo.nombre_comando</td>
                        <td>@item.parametro</td>
                        <td>
                            @if (item.para_todos == true)
                            {
                                <label>SI</label>
                            }
                            else
                            {
                                <label>NO</label>
                            }
                        </td>
                        <td>
                            @if (item.para_tipo != null)
                            {
                                @item.C_dispositivos_tipos.tipo_dispositivo
                            }
                        </td>
                        <td>@item.para_mac</td>
                        <td>
                            @if (item.es_perpetuo == true)
                            {
                                <label>SI</label>
                            }
                            else
                            {
                                <label>NO</label>
                            }
                        </td>
                        <td class="text-center">
                            @if (faltan == 0)
                            {
                                <span class="badge bg-success" title="Todos ejecutaron el comando" style="font-size:14px">0</span>
                            }
                            else if (faltan <= 4)
                            {
                                <span class="badge bg-warning" title="Faltan pocos dispositivos" style="font-size:14px">@faltan</span>
                            }
                            else
                            {
                                <span class="badge bg-danger" title="Varios dispositivos aún no lo ejecutan" style="font-size:14px">@faltan</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="col-md-12 card-group">
    <h2>COMANDOS EJECUTADOS</h2>
    <hr />
    <div style="overflow-x: auto; max-width: 100%;">
        <table class="table table-striped table-bordered" id="dispositivos_lista_ejecutados_table" style="width:100%; table-layout: fixed;">
            <thead>
                <tr class="bg-beta text-center">
                    <th>ID Global</th>
                    <th>Comando</th>
                    <th>MAC</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in comandosEjecutados.GroupBy(x => x.id_comando_global))
                {
                    <tr>
                        <td class="text-center">@item.FirstOrDefault().id_comando_global</td>
                        <td>@item.FirstOrDefault().C_dispositivos_comandos_globales.C_dispositivos_comandos_catalogo.nombre_comando</td>
                        <td>
                            @foreach (var dispositivo in item)
                            {
                                <label>@dispositivo.mac_address</label>
                                <br />
                            }
                        </td>
                        <td>
                            @foreach (var dispositivo in item)
                            {
                                @dispositivo.fecha_ejecucion
                                <br />
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


